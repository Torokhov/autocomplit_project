var autocompliteField=document.getElementById("autocomplite-field");autocompliteField.autocompliteLogic=new Autocomplite("data/kladr.json");var error=document.getElementById("error-message");var variants=document.getElementById("variants");var currentElem=null;variants.onclick=function(a){var b=a.target;if(b.tagName==="LI"){autocompliteField.value=b.textContent;this.classList.remove("variants-container--visible")}};variants.onmouseover=function(a){if(currentElem){return}var b=a.target;while(b!==this){if(b.tagName=="LI"){break}b=b.parentNode}if(b===this){return}currentElem=b;b.classList.add("variants-list__item--selected")};variants.onmouseout=function(b){if(!currentElem){return}var a=b.relatedTarget;if(a){while(a){if(a==currentElem){return}a=a.parentNode}}currentElem.classList.remove("variants-list__item--selected");currentElem=null};autocompliteField.onfocus=function(){this.select();this.classList.remove("text-field--error");error.classList.remove("error--visible")};autocompliteField.onblur=function(){var a=d.bind(this);setTimeout(a,200);function d(){if(this.value){if(variants.querySelector(".variants-list")&&variants.querySelector(".variants-list").children.length===1){this.value=variants.querySelector(".variants-list").firstChild.textContent;variants.classList.remove("variants-container--visible")}else{if(variants.querySelector(".variants-list")){var e=variants.querySelector(".variants-list");if(c(this.value,e.children).length===0){b()}}else{if(!variants.querySelector(".variants-list")&&!variants.querySelector(".message--server-error")){b()}}}}else{b()}}function b(){autocompliteField.classList.add("text-field--error");variants.classList.remove("variants-container--visible");error.classList.add("error--visible")}function c(f,e){return[].filter.call(e,function(g){return g.textContent===f})}};autocompliteField.addEventListener("input",inputHandler);function inputHandler(){var b=variants.getAttribute("data-list-size");var a=document.getElementById("loader");if(this.value){removeChildren(variants);variants.classList.add("variants-container--visible");if(!variants.querySelector(".message--server-error")){a.classList.add("loader-wrapper--visible")}setPosition();this.autocompliteLogic.getData(this.value).then(function(c){removeChildren(variants);if(c.length>b){variants.insertBefore(createMessage("amount",b,c.length),a)}if(c.length>0){return createList(c)}},function(){a.classList.add("loader-wrapper--visible");if(variants.querySelector(".message--server-error")){variants.querySelector(".btn--refresh-btn").style.display="none";variants.querySelector(".message--server-error").style.display="none"}setTimeout(function(){a.classList.remove("loader-wrapper--visible");if(!variants.querySelector(".message--server-error")){variants.insertBefore(createRefreshBtn(),variants.firstChild);variants.insertBefore(createMessage("server error"),variants.firstChild);setPosition()}else{variants.querySelector(".btn--refresh-btn").style.display="block";variants.querySelector(".message--server-error").style.display="block"}},1000);throw new Error("server error")}).then(function(c){if(c){if(variants.querySelector(".variants-list")){variants.removeChild(variants.querySelector(".variants-list"))}a.classList.remove("loader-wrapper--visible");variants.insertBefore(c,variants.firstChild);setPosition()}else{throw new Error("not data")}},function(c){return c}).then(null,function(c){if(c.message==="not data"&&!variants.querySelector(".message--not-found")&&!variants.querySelector(".variants-list")){a.classList.remove("loader-wrapper--visible");variants.insertBefore(createMessage("not found"),variants.firstChild);setPosition()}})}else{a.classList.remove("loader-wrapper--visible");variants.classList.remove("variants-container--visible")}}function setPosition(){var b=autocompliteField.getBoundingClientRect();var a=document.documentElement.clientHeight-b.bottom;if(a<variants.offsetHeight){variants.style.top=-variants.offsetHeight-3+"px"}else{variants.style.top=autocompliteField.offsetHeight+3+"px"}}function createList(f){var a=document.createDocumentFragment();var c=variants.getAttribute("data-list-size");var d;var b=0;while(b<c&&b<f.length){d=document.createElement("li");d.textContent=f[b].City;d.classList.add("variants-list__item");a.appendChild(d);b++}var e=document.createElement("ul");e.classList.add("variants-list");e.appendChild(a);e.firstChild.classList.add("variants-list__item--selected");currentElem=e.firstChild;return e}function createMessage(b,a,d){var c=document.createElement("div");switch(b){case"amount":c.textContent="Показано "+a+" из "+d+" найденных городов. Уточните запрос, чтобы увидеть остальные.";c.classList.add("message");return c;case"not found":c.textContent="Не найдено";c.classList.add("message--not-found");return c;case"server error":c.textContent="Что-то пошло не так. Проверьте соединение с интернетом и попробуйте еще раз";c.classList.add("message--server-error");return c}}function createRefreshBtn(){var a=document.createElement("div");a.textContent="Обновить";a.classList.add("btn--refresh-btn");a.addEventListener("click",inputHandler.bind(autocompliteField));return a}function removeChildren(a){while(a.children.length>1){a.removeChild(a.firstChild)}};